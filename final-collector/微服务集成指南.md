# OpenTelemetry Collector 微服务集成指南

## 🎯 概述
Final Collector 已就绪，请配置您的微服务连接到我们的自定义 OpenTelemetry Collector。

## 📡 连接信息
- **HTTP 端点**: `http://localhost:4326`
- **gRPC 端点**: `http://localhost:4325`
- **协议**: OTLP (OpenTelemetry Protocol)

## 🔧 微服务配置

### 环境变量配置 (推荐)
```bash
# 设置 OTLP 导出端点
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4326

# 设置服务名称
export OTEL_SERVICE_NAME=your-microservice-name

# 设置资源属性
export OTEL_RESOURCE_ATTRIBUTES=service.name=your-microservice,service.version=1.0.0
```

### Java Spring Boot 配置
```properties
# application.properties
management.otlp.tracing.endpoint=http://localhost:4326/v1/traces
management.tracing.sampling.probability=1.0
```

### Python 配置
```python
from opentelemetry import trace
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor

# 配置导出器
otlp_exporter = OTLPSpanExporter(
    endpoint="http://localhost:4326/v1/traces",
)

# 设置 trace provider
trace.set_tracer_provider(TracerProvider())
tracer = trace.get_tracer(__name__)

# 添加 span processor
trace.get_tracer_provider().add_span_processor(
    BatchSpanProcessor(otlp_exporter)
)
```

### Go 配置
```go
package main

import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
    "go.opentelemetry.io/otel/sdk/trace"
)

func main() {
    // 创建 OTLP 导出器
    exporter, err := otlptracehttp.New(
        context.Background(),
        otlptracehttp.WithEndpoint("http://localhost:4326"),
    )
    if err != nil {
        log.Fatal(err)
    }

    // 创建 trace provider
    tp := trace.NewTracerProvider(
        trace.WithBatcher(exporter),
    )
    otel.SetTracerProvider(tp)
}
```

### Node.js 配置
```javascript
const { NodeSDK } = require('@opentelemetry/sdk-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-otlp-http');

const sdk = new NodeSDK({
  traceExporter: new OTLPTraceExporter({
    url: 'http://localhost:4326/v1/traces',
  }),
});

sdk.start();
```

## 🚀 启动 Collector
```bash
cd "c:\Users\Lenovo\final-collector"
.\final-collector.exe --config=config.yml
```

## 📊 当前 Collector 配置详情

### 接收器 (Receivers)
- **OTLP**: 支持 HTTP 和 gRPC 协议
- **端口**: HTTP(4326), gRPC(4325)

### 处理器 (Processors)
- **TailSampling**: 智能采样处理器
  - 采样率: 100% (测试阶段)
  - 缓冲区: 5 traces (快速触发)
  - 决策时间: 1秒
  - 使用遗传算法优化

### 导出器 (Exporters)
- **Debug**: 详细控制台输出
- 显示接收到的所有 trace 数据

## 🔍 测试验证

### 1. 发送测试数据
从您的微服务发送一些简单的 HTTP 请求或业务操作。

### 2. 观察 Collector 日志
Collector 会显示类似这样的日志：
```
info    tailsamplingprocessor   Received traces batch
info    tailsamplingprocessor   Processing 1 traces in buffer
info    debugexporter           TracesExporter  {"traces": 1}
```

### 3. 验证数据流
- ✅ 微服务成功发送 traces
- ✅ Collector 接收并处理
- ✅ Debug 输出显示 trace 详情

## 🛠️ 常见问题

### 连接失败
```bash
# 检查端口是否被占用
netstat -an | findstr 4326
netstat -an | findstr 4325
```

### 防火墙问题
确保防火墙允许端口 4325 和 4326 的入站连接。

### CORS 问题 (Web 应用)
如果是前端应用，可能需要配置 CORS 头。

## 📈 生产环境调整

测试成功后，可以调整这些配置：
```yaml
tail_sampling:
  sample_rate: 0.1        # 调整为10%采样
  buffer_size: 1000       # 增加缓冲区
  decision_wait: 10s      # 延长决策时间
```

## 📞 支持

如果遇到问题，请提供：
1. 微服务的编程语言和框架
2. 错误日志
3. Collector 控制台输出

祝测试顺利！🎯
