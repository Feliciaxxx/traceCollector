# OpenTelemetry Collector å¾®æœåŠ¡é›†æˆæŒ‡å—

## ğŸ¯ æ¦‚è¿°
Final Collector å·²å°±ç»ªï¼Œè¯·é…ç½®æ‚¨çš„å¾®æœåŠ¡è¿æ¥åˆ°æˆ‘ä»¬çš„è‡ªå®šä¹‰ OpenTelemetry Collectorã€‚

## ğŸ“¡ è¿æ¥ä¿¡æ¯
- **HTTP ç«¯ç‚¹**: `http://localhost:4326`
- **gRPC ç«¯ç‚¹**: `http://localhost:4325`
- **åè®®**: OTLP (OpenTelemetry Protocol)

## ğŸ”§ å¾®æœåŠ¡é…ç½®

### ç¯å¢ƒå˜é‡é…ç½® (æ¨è)
```bash
# è®¾ç½® OTLP å¯¼å‡ºç«¯ç‚¹
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4326

# è®¾ç½®æœåŠ¡åç§°
export OTEL_SERVICE_NAME=your-microservice-name

# è®¾ç½®èµ„æºå±æ€§
export OTEL_RESOURCE_ATTRIBUTES=service.name=your-microservice,service.version=1.0.0
```

### Java Spring Boot é…ç½®
```properties
# application.properties
management.otlp.tracing.endpoint=http://localhost:4326/v1/traces
management.tracing.sampling.probability=1.0
```

### Python é…ç½®
```python
from opentelemetry import trace
from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor

# é…ç½®å¯¼å‡ºå™¨
otlp_exporter = OTLPSpanExporter(
    endpoint="http://localhost:4326/v1/traces",
)

# è®¾ç½® trace provider
trace.set_tracer_provider(TracerProvider())
tracer = trace.get_tracer(__name__)

# æ·»åŠ  span processor
trace.get_tracer_provider().add_span_processor(
    BatchSpanProcessor(otlp_exporter)
)
```

### Go é…ç½®
```go
package main

import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
    "go.opentelemetry.io/otel/sdk/trace"
)

func main() {
    // åˆ›å»º OTLP å¯¼å‡ºå™¨
    exporter, err := otlptracehttp.New(
        context.Background(),
        otlptracehttp.WithEndpoint("http://localhost:4326"),
    )
    if err != nil {
        log.Fatal(err)
    }

    // åˆ›å»º trace provider
    tp := trace.NewTracerProvider(
        trace.WithBatcher(exporter),
    )
    otel.SetTracerProvider(tp)
}
```

### Node.js é…ç½®
```javascript
const { NodeSDK } = require('@opentelemetry/sdk-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-otlp-http');

const sdk = new NodeSDK({
  traceExporter: new OTLPTraceExporter({
    url: 'http://localhost:4326/v1/traces',
  }),
});

sdk.start();
```

## ğŸš€ å¯åŠ¨ Collector
```bash
cd "c:\Users\Lenovo\final-collector"
.\final-collector.exe --config=config.yml
```

## ğŸ“Š å½“å‰ Collector é…ç½®è¯¦æƒ…

### æ¥æ”¶å™¨ (Receivers)
- **OTLP**: æ”¯æŒ HTTP å’Œ gRPC åè®®
- **ç«¯å£**: HTTP(4326), gRPC(4325)

### å¤„ç†å™¨ (Processors)
- **TailSampling**: æ™ºèƒ½é‡‡æ ·å¤„ç†å™¨
  - é‡‡æ ·ç‡: 100% (æµ‹è¯•é˜¶æ®µ)
  - ç¼“å†²åŒº: 5 traces (å¿«é€Ÿè§¦å‘)
  - å†³ç­–æ—¶é—´: 1ç§’
  - ä½¿ç”¨é—ä¼ ç®—æ³•ä¼˜åŒ–

### å¯¼å‡ºå™¨ (Exporters)
- **Debug**: è¯¦ç»†æ§åˆ¶å°è¾“å‡º
- æ˜¾ç¤ºæ¥æ”¶åˆ°çš„æ‰€æœ‰ trace æ•°æ®

## ğŸ” æµ‹è¯•éªŒè¯

### 1. å‘é€æµ‹è¯•æ•°æ®
ä»æ‚¨çš„å¾®æœåŠ¡å‘é€ä¸€äº›ç®€å•çš„ HTTP è¯·æ±‚æˆ–ä¸šåŠ¡æ“ä½œã€‚

### 2. è§‚å¯Ÿ Collector æ—¥å¿—
Collector ä¼šæ˜¾ç¤ºç±»ä¼¼è¿™æ ·çš„æ—¥å¿—ï¼š
```
info    tailsamplingprocessor   Received traces batch
info    tailsamplingprocessor   Processing 1 traces in buffer
info    debugexporter           TracesExporter  {"traces": 1}
```

### 3. éªŒè¯æ•°æ®æµ
- âœ… å¾®æœåŠ¡æˆåŠŸå‘é€ traces
- âœ… Collector æ¥æ”¶å¹¶å¤„ç†
- âœ… Debug è¾“å‡ºæ˜¾ç¤º trace è¯¦æƒ…

## ğŸ› ï¸ å¸¸è§é—®é¢˜

### è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -an | findstr 4326
netstat -an | findstr 4325
```

### é˜²ç«å¢™é—®é¢˜
ç¡®ä¿é˜²ç«å¢™å…è®¸ç«¯å£ 4325 å’Œ 4326 çš„å…¥ç«™è¿æ¥ã€‚

### CORS é—®é¢˜ (Web åº”ç”¨)
å¦‚æœæ˜¯å‰ç«¯åº”ç”¨ï¼Œå¯èƒ½éœ€è¦é…ç½® CORS å¤´ã€‚

## ğŸ“ˆ ç”Ÿäº§ç¯å¢ƒè°ƒæ•´

æµ‹è¯•æˆåŠŸåï¼Œå¯ä»¥è°ƒæ•´è¿™äº›é…ç½®ï¼š
```yaml
tail_sampling:
  sample_rate: 0.1        # è°ƒæ•´ä¸º10%é‡‡æ ·
  buffer_size: 1000       # å¢åŠ ç¼“å†²åŒº
  decision_wait: 10s      # å»¶é•¿å†³ç­–æ—¶é—´
```

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. å¾®æœåŠ¡çš„ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶
2. é”™è¯¯æ—¥å¿—
3. Collector æ§åˆ¶å°è¾“å‡º

ç¥æµ‹è¯•é¡ºåˆ©ï¼ğŸ¯
